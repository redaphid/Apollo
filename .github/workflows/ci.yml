name: CI

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BRANCH: ${{ github.head_ref || github.ref_name }}
  BUILD_VERSION: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
  COMMIT: ${{ github.sha }}
  BOOST_VERSION: '1.89.0'

jobs:
  windows:
    name: Windows
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-miniupnpc
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-nodejs
            mingw-w64-x86_64-nsis
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-opus
            mingw-w64-x86_64-pkgconf

      - name: Build and install MinHook
        run: |
          git clone --depth 1 https://github.com/TsudaKageyu/minhook.git /tmp/minhook
          cmake -S /tmp/minhook -B /tmp/minhook/build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build /tmp/minhook/build
          cp /tmp/minhook/build/libMinHook.a $MINGW_PREFIX/lib/
          cp /tmp/minhook/include/MinHook.h $MINGW_PREFIX/include/

      - name: Pre-download Boost
        run: |
          curl -fL --retry 3 -o /tmp/boost.tar.xz \
            "https://github.com/boostorg/boost/releases/download/boost-${BOOST_VERSION}/boost-${BOOST_VERSION}-cmake.tar.xz"
          mkdir -p /tmp/boost-src
          tar xf /tmp/boost.tar.xz -C /tmp/boost-src --strip-components=1

      - name: Setup problem matchers
        shell: bash
        run: |
          echo "::add-matcher::${{ github.workspace }}/.github/matchers/gcc.json"

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DSUNSHINE_ENABLE_TRAY=ON \
            -DFETCHCONTENT_SOURCE_DIR_BOOST=/tmp/boost-src

      - name: Build
        run: cmake --build build

      - name: Package NSIS installer
        run: cd build && cpack -G NSIS

      - name: Package portable ZIP
        run: cd build && cpack -G ZIP

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apollo-windows
          path: build/cpack_artifacts/*
          retention-days: 30

  linux:
    name: Linux
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CUDA toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: '12.6.3'
          method: network
          sub-packages: '["nvcc", "cudart"]'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake ninja-build pkg-config \
            libssl-dev libcurl4-openssl-dev \
            libminiupnpc-dev libopus-dev \
            libx11-dev libxrandr-dev libxfixes-dev \
            libdrm-dev libgbm-dev libcap-dev \
            libva-dev \
            libwayland-dev wayland-protocols \
            libevdev-dev \
            libpulse-dev libnuma-dev \
            libnotify-dev libayatana-appindicator3-dev \
            nodejs npm

      - name: Pre-download Boost
        run: |
          curl -fL --retry 3 -o /tmp/boost.tar.xz \
            "https://github.com/boostorg/boost/releases/download/boost-${BOOST_VERSION}/boost-${BOOST_VERSION}-cmake.tar.xz"
          mkdir -p /tmp/boost-src
          tar xf /tmp/boost.tar.xz -C /tmp/boost-src --strip-components=1

      - name: Setup problem matchers
        run: |
          echo "::add-matcher::${{ github.workspace }}/.github/matchers/gcc.json"

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DSUNSHINE_ENABLE_TRAY=ON \
            -DSUNSHINE_ENABLE_CUDA=ON \
            -DSUNSHINE_ENABLE_DRM=ON \
            -DSUNSHINE_ENABLE_VAAPI=ON \
            -DSUNSHINE_ENABLE_WAYLAND=ON \
            -DSUNSHINE_ENABLE_X11=ON \
            -DFETCHCONTENT_SOURCE_DIR_BOOST=/tmp/boost-src

      - name: Build
        run: cmake --build build

      - name: Package DEB
        run: cd build && cpack -G DEB

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apollo-linux
          path: build/cpack_artifacts/*
          retention-days: 30

  macos:
    name: macOS
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install \
            cmake ninja pkg-config \
            openssl@3 curl miniupnpc opus \
            node

      - name: Pre-download Boost
        run: |
          curl -fL --retry 3 -o /tmp/boost.tar.xz \
            "https://github.com/boostorg/boost/releases/download/boost-${BOOST_VERSION}/boost-${BOOST_VERSION}-cmake.tar.xz"
          mkdir -p /tmp/boost-src
          tar xf /tmp/boost.tar.xz -C /tmp/boost-src --strip-components=1

      - name: Setup problem matchers
        run: |
          echo "::add-matcher::${{ github.workspace }}/.github/matchers/gcc.json"

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DSUNSHINE_ENABLE_TRAY=ON \
            -DBOOST_USE_STATIC=OFF \
            -DFETCHCONTENT_SOURCE_DIR_BOOST=/tmp/boost-src

      - name: Build
        run: cmake --build build

      - name: Package DMG
        run: cd build && cpack -G DragNDrop

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apollo-macos
          path: build/cpack_artifacts/*
          retention-days: 30

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [windows, linux, macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: artifacts/**/*
