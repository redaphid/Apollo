name: CI

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BRANCH: ${{ github.head_ref || github.ref_name }}
  BUILD_VERSION: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
  COMMIT: ${{ github.sha }}
  BOOST_VERSION: '1.89.0'

jobs:
  windows:
    name: Windows
    runs-on: windows-2022
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            wget

      - name: Install dependencies
        run: |
          dependencies=(
            "git"
            "mingw-w64-ucrt-x86_64-boost"
            "mingw-w64-ucrt-x86_64-cmake"
            "mingw-w64-ucrt-x86_64-cppwinrt"
            "mingw-w64-ucrt-x86_64-curl-winssl"
            "mingw-w64-ucrt-x86_64-gcc"
            "mingw-w64-ucrt-x86_64-MinHook"
            "mingw-w64-ucrt-x86_64-miniupnpc"
            "mingw-w64-ucrt-x86_64-ninja"
            "mingw-w64-ucrt-x86_64-nlohmann-json"
            "mingw-w64-ucrt-x86_64-nodejs"
            "mingw-w64-ucrt-x86_64-nsis"
            "mingw-w64-ucrt-x86_64-onevpl"
            "mingw-w64-ucrt-x86_64-openssl"
            "mingw-w64-ucrt-x86_64-opus"
            "mingw-w64-ucrt-x86_64-toolchain"
          )
          pacman -Syu --noconfirm "${dependencies[@]}"

      - name: Pre-download Boost
        run: |
          curl -fL --retry 3 -o /tmp/boost.tar.xz \
            "https://github.com/boostorg/boost/releases/download/boost-${BOOST_VERSION}/boost-${BOOST_VERSION}-cmake.tar.xz"
          mkdir -p /tmp/boost-src
          tar xf /tmp/boost.tar.xz -C /tmp/boost-src --strip-components=1

      - name: Setup problem matchers
        shell: bash
        run: |
          echo "::add-matcher::${{ github.workspace }}/.github/matchers/gcc.json"

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DSUNSHINE_ENABLE_TRAY=ON \
            -DSUNSHINE_ASSETS_DIR=assets \
            -DFETCHCONTENT_SOURCE_DIR_BOOST=/tmp/boost-src

      - name: Build
        run: cmake --build build

      - name: Package
        run: |
          mkdir -p artifacts
          cd build
          cpack -G NSIS
          cpack -G ZIP
          mv ./cpack_artifacts/Apollo.exe ../artifacts/Apollo-installer.exe
          mv ./cpack_artifacts/Apollo.zip ../artifacts/Apollo-portable.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apollo-windows
          path: artifacts/*
          retention-days: 30

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: artifacts/**/*
